<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#050608">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Tari Profit Tracker (Pro)</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{--bg:#050608;--card:#111318;--accent:#00b894;--text-main:#f5f5f5;--text-muted:#9e9e9e;--border:#2c3038;}
    *{box-sizing:border-box;}
    body{margin:0;padding:10px;font-family:system-ui,-apple-system,sans-serif;background:radial-gradient(circle at top,#111318 0,#050608 45%,#000 100%);color:var(--text-main);padding-bottom:60px;}
    .wrapper{max-width:980px;margin:0 auto 32px auto;}
    .header{background:linear-gradient(135deg,#000,#111318);border-radius:18px;padding:14px 16px;box-shadow:0 14px 30px rgba(0,0,0,0.65);margin-bottom:14px;border:1px solid #272b35;text-align:center;}
    .header-title{font-size:20px;font-weight:700;}
    
    .card{background:linear-gradient(145deg,#111318,#0a0c10);border-radius:16px;padding:12px;margin-bottom:14px;border:1px solid #1f222a;}
    .section-title{font-size:13px;font-weight:700;margin:10px 0 6px;display:flex;justify-content:space-between;align-items:center;color:var(--accent);}
    .row2{display:flex;gap:10px;margin-bottom:6px;}
    .field{flex:1;}
    .field label{display:block;font-size:11px;margin-bottom:4px;color:var(--text-muted);}
    .field input{width:100%;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:#05070b;color:var(--text-main);outline:none;}
    .field input:focus{border-color:var(--accent);}
    
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th,td{padding:6px 4px;text-align:center;border-bottom:1px solid #222633;}
    th{background:#141821;color:var(--accent);}
    
    .summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px;}
    .summary-box{background:#0c1016;border-radius:14px;padding:8px;border:1px solid #262a35;text-align:center;}
    .summary-value{margin-top:4px;font-size:16px;font-weight:700;}
    
    .btn-row{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
    .btn{width:100%;padding:12px;border-radius:12px;border:none;font-weight:700;cursor:pointer;color:#fff;}
    .btn-main{background:linear-gradient(135deg,#00b894,#00a884);}
    .btn-update{background:linear-gradient(135deg,#e67e22,#d35400);} /* Orange for Update */
    .btn-share{background:#128C7E;}
    .btn-secondary{background:#374151;}
    .btn-ai{background:linear-gradient(135deg,#8e44ad,#9b59b6); margin-top:5px;}
    
    .ai-result{background:#151822; padding:10px; border-radius:12px; margin-top:8px; font-size:11px; display:none; border:1px dashed #8e44ad; line-height:1.6;}

    .sync-status {text-align: center;padding: 6px;margin-bottom: 10px;font-size: 11px;border-radius: 8px;display: none;}
    .sync-success { background: rgba(0,184,148,0.2); color: #00b894; display:block; }
    .sync-error { background: rgba(255,82,82,0.2); color: #ff5252; display:block; }
    .sync-loading { background: #2c3e50; color: #3498db; display:block; }
    
    /* Attachments Modal Styles */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99;justify-content:center;align-items:center;}
    .modal-content{background:#111;padding:20px;border-radius:16px;width:90%;max-width:400px;border:1px solid #333;}
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div class="header-title">Tari Profit Tracker <span style="font-size:10px;color:#00b894;border:1px solid #00b894;padding:2px 6px;border-radius:4px;">PRO</span></div>
    <div style="font-size:11px;color:#888;margin-top:5px;">System: Online & Syncing</div>
  </div>

  <div class="card">
    <div id="syncStatus" class="sync-status"></div>

    <div class="section-title"><span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span></div>
    <div class="row2">
      <div class="field"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label><input type="date" id="dateInput"></div>
      <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input type="text" id="noteInput" placeholder="..."></div>
    </div>
    
    <div class="section-title"><span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></div>
    <div class="row2">
      <div class="field"><label>ÙƒØ§Ø´</label><input type="number" id="salesCash"></div>
      <div class="field"><label>Ø´Ø¨ÙƒØ©</label><input type="number" id="salesCard"></div>
    </div>

    <div class="section-title"><span>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span><button class="btn-secondary" style="padding:2px 8px;border-radius:8px;" onclick="addRow('purchase')">+</button></div>
    <table id="purchasesTable"><tbody></tbody></table>

    <div class="section-title"><span>Ù…ØµØ±ÙˆÙØ§Øª</span><button class="btn-secondary" style="padding:2px 8px;border-radius:8px;" onclick="addRow('expense')">+</button></div>
    <table id="expensesTable"><tbody></tbody></table>
    
    <div class="section-title"><span>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙÙˆØ±ÙŠ</span></div>
    <div class="summary-grid">
      <div class="summary-box"><div style="color:#aaa;font-size:10px;">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div><div class="summary-value" id="netTodayDisplay" style="color:#00b894">0.00</div></div>
      <div class="summary-box"><div style="color:#aaa;font-size:10px;">ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´</div><div class="summary-value" id="netCashTodayDisplay" style="color:#3498db">0.00</div></div>
    </div>

    <button class="btn btn-ai" onclick="generateAIInsights()">ğŸ¤– ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (AI Insights)</button>
    <div id="aiResult" class="ai-result"></div>

    <div class="btn-row">
      <button id="saveBtn" class="btn btn-main" onclick="saveDay()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ… (Save New)</button>
      <button class="btn btn-share" onclick="alert('Feature coming soon!')">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button class="btn btn-secondary" onclick="newDay()">ğŸ“„ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ (Reset)</button>
      <button class="btn btn-secondary" style="background:#444;" onclick="forceUploadAll()">â˜ï¸ Force Upload All</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title"><span>Ø³Ø¬Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</span></div>
    <div style="overflow-x:auto;">
      <table style="width:100%;">
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>ØªØ¹Ø¯ÙŠÙ„</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ==========================================
// ğŸ”´ PASTE YOUR LINK HERE ğŸ”´
// ==========================================
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGduRoYBjW9ODGHL4p0mxI3TFFozm9wqtFAtPcy5L1ZvTLlOUe79Kly3t0OtTqeF5Xow/exec"; 


let entries=[], purchasesRows=[], expensesRows=[], rowIdSeq=1;

// --- CORE FUNCTIONS ---
function init(){
  document.getElementById("dateInput").value = new Date().toISOString().split('T')[0];
  initDefaultRows();
  ["salesCash","salesCard"].forEach(id=>document.getElementById(id).addEventListener("input",recalcLive));
  fetchFromCloud();
}

function initDefaultRows(){
  purchasesRows=[{id:1,name:"Romi",cash:"",card:""},{id:2,name:"Veg",cash:"",card:""}];
  expensesRows=[{id:3,name:"Gas",cash:"",card:""}];
  rowIdSeq=4;
  renderRows("purchase"); renderRows("expense");
}

function renderRows(kind){
  const arr = (kind==="purchase")?purchasesRows:expensesRows;
  const tb = document.getElementById(kind==="purchase"?"purchasesTable":"expensesTable").querySelector("tbody");
  tb.innerHTML = arr.map(r => `
    <tr>
      <td><input value="${r.name||''}" oninput="updateRow('${kind}',${r.id},'name',this.value)" placeholder="Name" style="background:transparent;border:none;color:#fff;width:100%;"></td>
      <td><input type="number" value="${r.cash||''}" oninput="updateRow('${kind}',${r.id},'cash',this.value)" placeholder="0" style="background:#111;border:1px solid #333;color:#fff;width:60px;border-radius:4px;"></td>
      <td><input type="number" value="${r.card||''}" oninput="updateRow('${kind}',${r.id},'card',this.value)" placeholder="0" style="background:#111;border:1px solid #333;color:#fff;width:60px;border-radius:4px;"></td>
      <td onclick="delRow('${kind}',${r.id})" style="color:red;cursor:pointer;">Ã—</td>
    </tr>`).join('');
}

window.updateRow=(k,id,f,v)=>{ const arr=(k==="purchase")?purchasesRows:expensesRows; const r=arr.find(x=>x.id===id); if(r){r[f]=v; recalcLive();} };
window.delRow=(k,id)=>{ const arr=(k==="purchase")?purchasesRows:expensesRows; const idx=arr.findIndex(x=>x.id===id); if(idx>-1){arr.splice(idx,1); renderRows(k); recalcLive();} };
window.addRow=(k)=>{ const arr=(k==="purchase")?purchasesRows:expensesRows; arr.push({id:rowIdSeq++,name:"",cash:"",card:""}); renderRows(k); };

function recalcLive(){
  const sc=Number(document.getElementById("salesCash").value)||0;
  const sd=Number(document.getElementById("salesCard").value)||0;
  
  let pc=0, pd=0; purchasesRows.forEach(r=>{ pc+=Number(r.cash)||0; pd+=Number(r.card)||0; });
  let ec=0, ed=0; expensesRows.forEach(r=>{ ec+=Number(r.cash)||0; ed+=Number(r.card)||0; });
  
  const net = (sc+sd) - (pc+pd) - (ec+ed);
  const netCash = sc - (pc+ec);
  
  document.getElementById("netTodayDisplay").textContent = net.toFixed(2);
  document.getElementById("netCashTodayDisplay").textContent = netCash.toFixed(2);
  
  return {date:document.getElementById("dateInput").value, net, netCash, sc, sd, purchasesRows, expensesRows};
}

// --- SAVE / EDIT LOGIC ---
function saveDay(){
  const data = recalcLive();
  const existingIdx = entries.findIndex(e => e.date === data.date);
  
  if(existingIdx >= 0){
    entries[existingIdx] = data; // Update local
  } else {
    entries.push(data); // Add new
  }
  
  renderHistory();
  sendToCloud(data);
  
  // Return to "New Day" mode
  alert("Saved/Updated Successfully!");
  newDay(); 
}

function loadDayToForm(date){
  const e = entries.find(x => x.date === date);
  if(!e) return;
  
  document.getElementById("dateInput").value = e.date;
  document.getElementById("salesCash").value = e.sc||"";
  document.getElementById("salesCard").value = e.sd||"";
  purchasesRows = e.purchasesRows || [];
  expensesRows = e.expensesRows || [];
  
  renderRows("purchase"); renderRows("expense");
  recalcLive();
  
  // CHANGE BUTTON STYLE
  const btn = document.getElementById("saveBtn");
  btn.textContent = "ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù (Update Existing)";
  btn.className = "btn btn-update";
  window.scrollTo({top:0, behavior:'smooth'});
}

function newDay(){
  document.getElementById("dateInput").value = new Date().toISOString().split('T')[0];
  document.getElementById("salesCash").value = "";
  document.getElementById("salesCard").value = "";
  initDefaultRows();
  recalcLive();
  
  // RESET BUTTON STYLE
  const btn = document.getElementById("saveBtn");
  btn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ… (Save New)";
  btn.className = "btn btn-main";
}

function renderHistory(){
  entries.sort((a,b)=> b.date.localeCompare(a.date)); // Newest first
  document.getElementById("historyBody").innerHTML = entries.map(e => `
    <tr>
      <td>${e.date}</td>
      <td style="color:${e.net>=0?'#00b894':'#ff5252'}">${e.net?.toFixed(0)}</td>
      <td><button class="btn-secondary" style="padding:4px 10px;font-size:10px;" onclick="loadDayToForm('${e.date}')">âœï¸ Edit</button></td>
    </tr>`).join('');
}

// --- CLOUD SYNC ---
async function sendToCloud(data){
  const status = document.getElementById("syncStatus");
  status.textContent = "Syncing..."; status.style.display="block"; status.className="sync-status sync-loading";
  
  try {
    await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST', redirect: "follow",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(data)
    });
    status.textContent = "Saved to Cloud âœ…"; status.className="sync-status sync-success";
  } catch(e) {
    status.textContent = "Cloud Error âŒ"; status.className="sync-status sync-error";
  }
}

async function fetchFromCloud(){
  try {
    const res = await fetch(GOOGLE_SCRIPT_URL, {redirect:"follow"});
    const data = await res.json();
    if(Array.isArray(data)) { entries = data; renderHistory(); }
  } catch(e) { console.log(e); }
}

async function forceUploadAll(){
  if(!confirm("Re-upload all history?")) return;
  for(const e of entries) await sendToCloud(e);
  alert("Done");
}

// --- AI INSIGHTS ---
function generateAIInsights() {
  const d = recalcLive();
  const resultDiv = document.getElementById("aiResult");
  resultDiv.style.display = "block";
  
  let msg = `ğŸ“Š <b>Report for ${d.date}:</b><br>`;
  
  if(d.net > 0) msg += `âœ… Good job! You made a profit of <b>${d.net.toFixed(2)}</b>.<br>`;
  else msg += `âš ï¸ Warning: Net loss of <b>${d.net.toFixed(2)}</b>.<br>`;
  
  if(d.netCash < 0) msg += `ğŸ“‰ Cash Flow Alert: You paid more cash than you collected.<br>`;
  
  const totalExp = d.sc + d.sd - d.net; // Approx expense calc
  if(totalExp > (d.sc+d.sd)*0.5) msg += `ğŸ’¡ Tip: Your costs are very high (${totalExp.toFixed(2)}) compared to sales.<br>`;
  
  msg += `<br><i>(This is a local AI analysis based on your rules)</i>`;
  resultDiv.innerHTML = msg;
}

init();
</script>
</body>
</html>
