<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#050608">
  <title>Tari Profit Tracker (DEBUG)</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    /* STYLES */
    :root{--bg:#050608;--card:#111318;--accent:#00b894;--text-main:#f5f5f5;--text-muted:#9e9e9e;}
    *{box-sizing:border-box;}
    body{margin:0;padding:10px;font-family:system-ui,-apple-system,sans-serif;background:#000;color:var(--text-main);padding-bottom:100px;}
    .card{background:#111318;border-radius:16px;padding:12px;border:1px solid #1f222a;margin-bottom:14px;}
    .btn{width:100%;padding:12px;border-radius:12px;border:none;font-weight:bold;cursor:pointer;color:#fff;background:#1f2933;margin-top:5px;}
    .btn-main{background:#00b894;}
    .btn-debug{background:#e67e22; margin-bottom: 10px;}
    
    /* DEBUG CONSOLE STYLES */
    #debugConsole {
      background: #111;
      border: 1px solid #333;
      color: #0f0;
      font-family: monospace;
      font-size: 10px;
      padding: 10px;
      margin-top: 20px;
      border-radius: 8px;
      min-height: 150px;
      white-space: pre-wrap;
      direction: ltr; /* Logs are in English */
      text-align: left;
    }
    input { width: 100%; padding: 8px; background: #222; border: 1px solid #333; color: #fff; border-radius: 8px; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div class="card">
    <h2 style="text-align:center; color: #00b894;">üîß Debug Mode</h2>
    
    <button class="btn btn-debug" onclick="testConnection()">üõ† CHECK CLOUD CONNECTION</button>
    <button class="btn btn-main" onclick="saveTestRow()">‚òÅÔ∏è Try Uploading Test Data</button>
    
    <div id="debugConsole">Waiting for test...</div>
  </div>

  <div class="card">
    <h3>Original App Interface</h3>
    <input type="date" id="dateInput">
    <input type="number" id="salesCash" placeholder="Sales Cash">
    <div style="font-size:12px; color:#aaa; margin-top:5px;">(Simplified for testing)</div>
  </div>

<script>
// ==========================================
// üî¥ PASTE YOUR LINK HERE ONE LAST TIME
// ==========================================
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGduRoYBjW9ODGHL4p0mxI3TFFozm9wqtFAtPcy5L1ZvTLlOUe79Kly3t0OtTqeF5Xow/exec"; 


// LOGGER FUNCTION
function log(msg) {
  const box = document.getElementById("debugConsole");
  const time = new Date().toLocaleTimeString();
  box.innerHTML += `[${time}] ${msg}\n`;
  console.log(msg);
}

async function testConnection() {
  const box = document.getElementById("debugConsole");
  box.innerHTML = "--- STARTING CONNECTION TEST ---\n";
  
  if(GOOGLE_SCRIPT_URL.includes("PASTE_YOUR")) {
    log("‚ùå ERROR: You didn't paste the Google Link in the code!");
    return;
  }

  log("1. URL Check: " + GOOGLE_SCRIPT_URL);
  
  try {
    log("2. Attempting GET request...");
    
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: "GET",
      redirect: "follow" // CRITICAL: Follow Google's redirects
    });

    log("3. Server Responded. Status: " + response.status);
    
    if (response.status === 200) {
      const text = await response.text();
      log("4. Response Data: " + text.substring(0, 100) + "...");
      
      try {
        const json = JSON.parse(text);
        log("‚úÖ SUCCESS! Valid JSON received.");
        log("Items found in cloud: " + json.length);
        if(json.length > 0) {
          log("Last Entry Date: " + json[json.length-1].date);
        } else {
          log("Cloud is empty (but connected).");
        }
      } catch(e) {
        log("‚ö†Ô∏è WARNING: Could not parse JSON. Is the sheet empty?");
      }
    } else {
      log("‚ùå ERROR: Server returned " + response.status);
    }
  } catch (error) {
    log("‚ùå CRITICAL FAILURE: " + error.message);
    log("Hint: Check internet or CORS permissions.");
  }
}

async function saveTestRow() {
  log("\n--- STARTING UPLOAD TEST ---");
  const testData = {
    date: new Date().toISOString().split('T')[0],
    net: 123,
    netCash: 123,
    note: "Debug Upload",
    fullData: "Debug Test"
  };
  
  try {
    log("1. Sending POST request...");
    
    // Using simple text/plain to bypass strict CORS checks
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      redirect: "follow",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(testData)
    });
    
    log("2. Upload Status: " + response.status);
    const txt = await response.text();
    log("3. Server Said: " + txt);
    
    if(txt.includes("Success")) {
      log("‚úÖ UPLOAD SUCCESSFUL!");
    } else {
      log("‚ùå UPLOAD FAILED.");
    }
    
  } catch(e) {
    log("‚ùå UPLOAD CRASH: " + e.message);
  }
}
</script>
</body>
</html>
