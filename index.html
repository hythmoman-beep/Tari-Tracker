<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#050608">
  <title>Tari Profit Tracker AI</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    /* ... (CSS STYLES SAME AS BEFORE) ... */
    :root{--bg:#050608;--card:#111318;--accent:#00b894;--accent-soft:#004d40;--danger:#ff5252;--warning:#f1c40f;--text-main:#f5f5f5;--text-muted:#9e9e9e;--border:#2c3038;}
    *{box-sizing:border-box;}
    body{margin:0;padding:10px;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:radial-gradient(circle at top,#111318 0,#050608 45%,#000 100%);color:var(--text-main);-webkit-tap-highlight-color:transparent;padding-bottom:60px;}
    .wrapper{max-width:980px;margin:0 auto 32px auto;}
    .header{background:linear-gradient(135deg,#000,#111318);border-radius:18px;padding:14px 16px;box-shadow:0 14px 30px rgba(0,0,0,0.65);margin-bottom:14px;border:1px solid #272b35;text-align:center;}
    .header-title{font-size:20px;font-weight:700;margin-bottom:4px;}
    .header-sub{font-size:11px;color:var(--text-muted);line-height:1.5;}
    .card{background:linear-gradient(145deg,#111318,#0a0c10);border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.55);border:1px solid #1f222a;margin-bottom:14px;}
    .section-title{font-size:13px;font-weight:700;margin:10px 0 6px;display:flex;justify-content:space-between;align-items:center;color:var(--accent);}
    .row2{display:flex;gap:10px;margin-bottom:6px;}
    @media(max-width:720px){.row2{flex-direction:column;}}
    .field{flex:1;}
    .field label{display:block;font-size:11px;margin-bottom:4px;color:var(--text-muted);}
    .field input[type="date"],.field input[type="text"],.field input[type="number"]{width:100%;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:#05070b;color:var(--text-main);font-size:13px;outline:none;}
    .field input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(0,184,148,0.8);}
    table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:4px;}
    th,td{padding:6px 4px;text-align:center;border-bottom:1px solid #222633;}
    th{background:#141821;color:var(--accent);font-weight:600;}
    tr:nth-child(even) td{background:#0f1218;}
    .cat-input{width:100%;padding:4px 6px;border-radius:8px;border:1px solid var(--border);background:#05070b;color:var(--text-main);font-size:12px;outline:none;}
    .cat-input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(0,184,148,0.8);}
    .btn-small{padding:4px 9px;font-size:11px;border-radius:999px;border:1px dashed #374151;background:#111318;color:var(--text-muted);cursor:pointer;}
    .summary-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px;}
    @media(min-width:780px){.summary-grid{grid-template-columns:repeat(3,minmax(0,1fr));}}
    .summary-box{background:#0c1016;border-radius:14px;padding:8px;border:1px solid #262a35;text-align:center;font-size:12px;box-shadow:0 4px 14px rgba(0,0,0,0.6);}
    .summary-box-total{background:radial-gradient(circle at top,#00b894,#004d40);border-color:#00b894;color:#ffffff;}
    .summary-box-month{background:radial-gradient(circle at top,#2980b9,#1a5276);border-color:#3498db;color:#ffffff;}
    .summary-label{color:var(--text-muted);font-size:11px;}
    .summary-box-total .summary-label,.summary-box-month .summary-label{color:rgba(255,255,255,0.8);}
    .summary-value{margin-top:4px;font-size:16px;font-weight:700;}
    .btn-row{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
    .btn{width:100%;padding:12px 10px;border-radius:12px;border:none;font-size:13px;font-weight:600;cursor:pointer;color:#fff;background:#1f2933;box-shadow:0 6px 14px rgba(0,0,0,0.7);transition:transform 0.1s;}
    .btn:active{transform:scale(0.98);}
    .btn-main{background:linear-gradient(135deg,#00b894,#00a884);}
    .btn-share{background:#128C7E;}
    .btn-secondary{background:#374151;}
    .btn-danger{background:#c0392b;}
    .data-tools{display:flex;gap:8px;margin-top:10px;}
    .btn-data{flex:1;background:#2c3e50;font-size:11px;padding:8px;border-radius:8px;color:#bdc3c7;border:1px solid #34495e;}
    .hist-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:12px;}
    .hist-title{font-weight:700;}.hist-title span{color:var(--accent);}
    .hist-info{color:var(--text-muted);font-size:11px;}
    .history-row-bad td{background:#22080b !important;}
    .note{margin-top:8px;font-size:10px;color:var(--text-muted);line-height:1.5;}
    .ai-list{font-size:11px;margin:0;padding-left:18px;direction:rtl;}
    .ai-list li{margin-bottom:6px;position:relative;}
    .ai-tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:bold;margin-left:5px;}
    .tag-green{background:rgba(0,184,148,0.2);color:#00b894;}
    .tag-red{background:rgba(255,82,82,0.2);color:#ff5252;}
    .tag-blue{background:rgba(52,152,219,0.2);color:#3498db;}
    .tag-yellow{background:rgba(241,196,15,0.2);color:#f1c40f;}
    /* Floating upload modal */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;justify-content:center;align-items:center;padding:16px;backdrop-filter:blur(4px);}
    .modal-content{background:#111318;border-radius:18px;border:1px solid #2a2d37;max-width:520px;width:100%;max-height:90vh;overflow-y:auto;padding:16px 16px 18px;box-shadow:0 18px 40px rgba(0,0,0,0.9);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .modal-title{font-size:14px;font-weight:700;}
    .modal-close{background:none;border:none;color:#aaa;font-size:22px;cursor:pointer;}
    .upload-group{background:#151822;border-radius:12px;border:1px solid #303443;padding:10px 10px;margin-bottom:10px;}
    .group-label{font-size:12px;color:var(--accent);margin-bottom:6px;border-bottom:1px solid #262a35;padding-bottom:4px;font-weight:600;}
    .up-btn-row{display:flex;gap:8px;flex-wrap:wrap;}
    .up-btn{flex:1 1 140px;border-radius:10px;border:1px dashed #4b5163;background:#191d28;padding:10px 6px;cursor:pointer;font-size:11px;color:#d1d5db;text-align:center;}
    .up-btn:hover{border-color:var(--accent);background:#1f2330;}
    .file-list{margin-top:6px;display:flex;flex-direction:column;gap:4px;}
    .file-tag{background:#050608;border-radius:7px;padding:4px 8px;font-size:10px;display:flex;justify-content:space-between;align-items:center;border-right:3px solid var(--accent);}
    .file-name{max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .del-file{cursor:pointer;color:#ff7676;font-weight:700;padding-left:6px;}
    @media print{body{background:#000;padding:0;}.btn-row,.note,.modal-overlay,.data-tools{display:none !important;}.card,.header{box-shadow:none;border-radius:0;}}
  </style>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div class="header-title">Tari Profit Tracker</div>
    <div class="header-sub">
      ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª âˆ’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª âˆ’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª<br>
      ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´ = ÙƒØ§Ø´ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª âˆ’ (ÙƒØ§Ø´ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª + ÙƒØ§Ø´ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª)
    </div>
  </div>

  <div class="card">
    <div class="section-title"><span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span></div>
    <div class="row2">
      <div class="field"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label><input type="date" id="dateInput"></div>
      <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="text" id="noteInput" placeholder="Ù…Ø«Ø§Ù„: Ø´ØºÙ„ Ø¶Ø¹ÙŠÙØŒ Ù…Ø·Ø±ØŒ Ø¹Ø±ÙˆØ¶ .."></div>
    </div>
    <div class="section-title"><span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></div>
    <div class="row2">
      <div class="field"><label>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</label><input type="number" id="salesCash" min="0" step="0.01"></div>
      <div class="field"><label>Ù…Ø¨ÙŠØ¹Ø§Øª Ø´Ø¨ÙƒØ©</label><input type="number" id="salesCard" min="0" step="0.01"></div>
    </div>
    <div class="section-title"><span>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©)</span><button type="button" class="btn-small" onclick="addRow('purchase')">Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„</button></div>
    <div style="overflow-x:auto;"><table><thead><tr><th>Ø§Ù„ÙØ¦Ø©</th><th>ÙƒØ§Ø´</th><th>Ø´Ø¨ÙƒØ©</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="purchasesBody"></tbody></table></div>
    <div class="section-title"><span>Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ©</span><button type="button" class="btn-small" onclick="addRow('expense')">Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„</button></div>
    <div style="overflow-x:auto;"><table><thead><tr><th>Ø§Ù„ÙØ¦Ø©</th><th>ÙƒØ§Ø´</th><th>Ø´Ø¨ÙƒØ©</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="expensesBody"></tbody></table></div>
    
    <div class="section-title"><span>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ÙÙˆØ±ÙŠ</span></div>
    <div class="summary-grid">
      <div class="summary-box"><div class="summary-label">ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…</div><div class="summary-value" id="netTodayDisplay">0.00</div></div>
      <div class="summary-box"><div class="summary-label">ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ…</div><div class="summary-value" id="netCashTodayDisplay">0.00</div></div>
      <div class="summary-box summary-box-total"><div class="summary-label">ØªØ±Ø§ÙƒÙ…ÙŠ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div><div class="summary-value" id="totalNetAllDisplay">0.00</div></div>
      <div class="summary-box summary-box-total"><div class="summary-label">ØªØ±Ø§ÙƒÙ…ÙŠ ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´</div><div class="summary-value" id="totalNetCashAllDisplay">0.00</div></div>
      <div class="summary-box summary-box-month"><div class="summary-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div><div class="summary-value" id="monthSalesDisplay">0.00</div></div>
    </div>

    <div class="btn-row">
      <button class="btn btn-main" onclick="saveDay()">Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ… / ØªØ­Ø¯ÙŠØ«Ù‡</button>
      <button class="btn btn-share" onclick="openUploadModal()">Ù…Ø´Ø§Ø±ÙƒØ© / Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… (HTML)</button>
      <button class="btn btn-secondary" onclick="newDay()">ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯</button>
      <button class="btn btn-danger" onclick="clearAll()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <div class="data-tools">
      <button class="btn btn-data" onclick="backupData()">ğŸ“¥ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Backup)</button>
      <button class="btn btn-data" onclick="document.getElementById('importFile').click()">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª (Restore)</button>
    </div>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="restoreData(this)">
  </div>

  <div class="card">
    <div class="hist-header">
      <div class="hist-title">Ø³Ø¬Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© <span>(Ù…Ø­ÙÙˆØ¸Ø©)</span></div>
      <div class="hist-info" id="rangeSummary"></div>
    </div>
    <div style="overflow-x:auto;">
      <table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th><th>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</th><th>ØµØ§ÙÙŠ Ø§Ù„ÙƒØ§Ø´</th><th>ØªØ¹Ø¯ÙŠÙ„</th></tr></thead><tbody id="historyBody"></tbody></table>
    </div>
    <div class="note" id="totalsFooter"></div>
  </div>

  <div class="card">
    <div class="section-title"><span>ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ (AI Insights)</span></div>
    <div id="aiInsights" class="note">ÙŠØªÙ… ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... Ø§Ø­ÙØ¸ 3 Ø£ÙŠØ§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª.</div>
  </div>
</div>

<div id="uploadModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</div><button class="modal-close" onclick="closeUploadModal()">Ã—</button></div>
    
    <div class="upload-group">
      <div class="group-label">Summary & Report (ØªÙ‚Ø§Ø±ÙŠØ± ÙˆÙ…Ù„Ø®ØµØ§Øª)</div>
      <div class="up-btn-row"><button class="up-btn" type="button" onclick="setAttachType('summaryReport')">Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª (ØµÙˆØ± / PDF)</button></div>
      <div id="list_summaryReport" class="file-list"></div>
    </div>
    <div class="upload-group">
      <div class="group-label">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ÙƒØ§Ø´)</div>
      <div class="up-btn-row"><button class="up-btn" type="button" onclick="setAttachType('purchCash')">Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª</button></div>
      <div id="list_purchCash" class="file-list"></div>
    </div>
    <div class="upload-group">
      <div class="group-label">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø´Ø¨ÙƒØ©)</div>
      <div class="up-btn-row"><button class="up-btn" type="button" onclick="setAttachType('purchCard')">Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª</button></div>
      <div id="list_purchCard" class="file-list"></div>
    </div>
    <div class="upload-group">
      <div class="group-label">Ø¥ÙŠØµØ§Ù„Ø§Øª POS</div>
      <div class="up-btn-row"><button class="up-btn" type="button" onclick="setAttachType('pos')">Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª</button></div>
      <div id="list_pos" class="file-list"></div>
    </div>

    <input id="fileInput" type="file" multiple accept="image/*,application/pdf" style="display:none" onchange="handleFiles(this)">
    <button class="btn btn-share" style="margin-top:10px;" type="button" onclick="generateAndShareReport()">Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
  </div>
</div>

<script>
// REGISTER SERVICE WORKER
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW Registered!', reg))
      .catch(err => console.log('SW Failed', err));
  });
}

// APP LOGIC (Condensed for brevity - same logic as v4)
const KEY = "tari_profit_entries_v3";
let entries=[], purchasesRows=[], expensesRows=[], rowIdSeq=1;
let attachments = {summaryReport:[], purchCash:[], purchCard:[], pos:[]};
let currentAttachType = "purchCash";

function toNum(v){const n=parseFloat(v);return isNaN(n)?0:n;}
function formatMoney(n){return n.toFixed(2);}
function todayISO(){const d=new Date();const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,"0");const day=String(d.getDate()).padStart(2,"0");return `${y}-${m}-${day}`;}

function loadEntries(){try{const raw=localStorage.getItem(KEY);entries=raw?JSON.parse(raw):[];}catch(e){entries=[];}}
function saveEntries(){localStorage.setItem(KEY, JSON.stringify(entries));}
function backupData(){const blob=new Blob([JSON.stringify(entries)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`Tari_Backup_${todayISO()}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
function restoreData(input){const file=input.files[0];if(!file)return;const r=new FileReader();r.onload=e=>{try{const l=JSON.parse(e.target.result);if(Array.isArray(l)&&confirm("Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")){entries=l;saveEntries();renderHistory();recalcLive();alert("ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©!");}}catch(er){alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");}};r.readAsText(file);input.value="";}

function initDefaultRows(){
  purchasesRows=[{id:rowIdSeq++,name:"Romi",cash:"",card:""},{id:rowIdSeq++,name:"Vegetables",cash:"",card:""},{id:rowIdSeq++,name:"Packaging",cash:"",card:""}];
  expensesRows=[{id:rowIdSeq++,name:"Gas",cash:"",card:""},{id:rowIdSeq++,name:"Fuel",cash:"",card:""},{id:rowIdSeq++,name:"Water",cash:"",card:""},{id:rowIdSeq++,name:"Rent",cash:"",card:""}];
}
function renderRows(kind){
  const rows=(kind==="purchase")?purchasesRows:expensesRows;
  const tbody=document.getElementById(kind==="purchase"?"purchasesBody":"expensesBody");
  tbody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><input type="text" class="cat-input" value="${r.name||''}" data-kind="${kind}" data-id="${r.id}" data-field="name" oninput="handleRowInput(event)" placeholder="Ø§Ù„ÙØ¦Ø©"></td>
    <td><input type="number" step="0.01" class="cat-input" value="${r.cash||''}" data-kind="${kind}" data-id="${r.id}" data-field="cash" oninput="handleRowInput(event)" placeholder="ÙƒØ§Ø´"></td>
    <td><input type="number" step="0.01" class="cat-input" value="${r.card||''}" data-kind="${kind}" data-id="${r.id}" data-field="card" oninput="handleRowInput(event)" placeholder="Ø´Ø¨ÙƒØ©"></td>
    <td><button type="button" class="btn-small" style="color:#ff5252" onclick="deleteRow('${kind}',${r.id})">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
}
window.handleRowInput=(e)=>{const k=e.target.dataset.kind,id=parseInt(e.target.dataset.id),f=e.target.dataset.field;const arr=(k==="purchase")?purchasesRows:expensesRows;const r=arr.find(x=>x.id===id);if(r){r[f]=e.target.value;recalcLive();}};
window.addRow=(k)=>{const arr=(k==="purchase")?purchasesRows:expensesRows;arr.push({id:rowIdSeq++,name:"",cash:"",card:""});renderRows(k);recalcLive();};
window.deleteRow=(k,id)=>{const arr=(k==="purchase")?purchasesRows:expensesRows;const i=arr.findIndex(x=>x.id===id);if(i!==-1){arr.splice(i,1);renderRows(k);recalcLive();}};

function computeTotals(sc,sd,pr,er){
  let pc=0,pd=0,ec=0,ed=0;
  (pr||[]).forEach(r=>{pc+=toNum(r.cash);pd+=toNum(r.card);});
  (er||[]).forEach(r=>{ec+=toNum(r.cash);ed+=toNum(r.card);});
  const ts=sc+sd, tp=pc+pd, te=ec+ed;
  return {salesCash:sc,salesCard:sd,pCash:pc,pCard:pd,eCash:ec,eCard:ed,totalSales:ts,totalPurchases:tp,totalExpenses:te,net:ts-tp-te,netCash:sc-(pc+ec)};
}
function recalcLive(){
  const sc=toNum(document.getElementById("salesCash").value), sd=toNum(document.getElementById("salesCard").value);
  const t=computeTotals(sc,sd,purchasesRows,expensesRows);
  document.getElementById("netTodayDisplay").textContent=formatMoney(t.net);
  document.getElementById("netCashTodayDisplay").textContent=formatMoney(t.netCash);
  const d=document.getElementById("dateInput").value||todayISO();
  let bn=0,bnc=0, mtot=0, mp=d.substring(0,7);
  entries.forEach(e=>{
    if(e.date!==d){bn+=e.net||0;bnc+=e.netCash||0;}
    if(e.date.startsWith(mp)&&e.date!==d){const ot=computeTotals(e.salesCash||0,e.salesCard||0,e.purchasesRows||[],e.expensesRows||[]);mtot+=ot.totalSales;}
  });
  mtot+=t.totalSales;
  document.getElementById("totalNetAllDisplay").textContent=formatMoney(bn+t.net);
  document.getElementById("totalNetCashAllDisplay").textContent=formatMoney(bnc+t.netCash);
  document.getElementById("monthSalesDisplay").textContent=formatMoney(mtot);
  return {...t,totalNetAll:bn+t.net,totalNetCashAll:bnc+t.netCash,monthlySalesTotal:mtot};
}

function getCurrentData(){
  const sc=toNum(document.getElementById("salesCash").value), sd=toNum(document.getElementById("salesCard").value);
  const t=computeTotals(sc,sd,purchasesRows,expensesRows);
  return {date:document.getElementById("dateInput").value||todayISO(),note:document.getElementById("noteInput").value||"",salesCash:sc,salesCard:sd,purchasesRows:JSON.parse(JSON.stringify(purchasesRows)),expensesRows:JSON.parse(JSON.stringify(expensesRows)),net:t.net,netCash:t.netCash};
}
window.saveDay=()=>{const d=getCurrentData();document.getElementById("dateInput").value=d.date;const i=entries.findIndex(e=>e.date===d.date);if(i>=0)entries[i]=d;else entries.push(d);saveEntries();renderHistory();recalcLive();alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");};
window.newDay=()=>{document.getElementById("dateInput").value=todayISO();document.getElementById("noteInput").value="";document.getElementById("salesCash").value="";document.getElementById("salesCard").value="";initDefaultRows();renderRows("purchase");renderRows("expense");recalcLive();};
window.clearAll=()=>{if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")){entries=[];saveEntries();newDay();renderHistory();recalcLive();}};

window.loadDayToForm=(date)=>{
  const e=entries.find(x=>x.date===date);
  if(!e){document.getElementById("noteInput").value="";document.getElementById("salesCash").value="";document.getElementById("salesCard").value="";initDefaultRows();}
  else{
    document.getElementById("dateInput").value=e.date;
    document.getElementById("noteInput").value=e.note||"";
    document.getElementById("salesCash").value=e.salesCash??"";
    document.getElementById("salesCard").value=e.salesCard??"";
    purchasesRows=e.purchasesRows?JSON.parse(JSON.stringify(e.purchasesRows)):[];
    expensesRows=e.expensesRows?JSON.parse(JSON.stringify(e.expensesRows)):[];
    if(!purchasesRows.length&&!expensesRows.length)initDefaultRows();
  }
  renderRows("purchase");renderRows("expense");recalcLive();
};

function renderHistory(){
  entries.sort((a,b)=>(a.date||"").localeCompare(b.date||""));
  const b=document.getElementById("historyBody");b.innerHTML="";
  let sn=0,snc=0;
  entries.forEach(e=>{
    const t=computeTotals(e.salesCash||0,e.salesCard||0,e.purchasesRows||[],e.expensesRows||[]);
    sn+=t.net;snc+=t.netCash;
    const tr=document.createElement("tr");
    if(t.net<0||t.netCash<0)tr.classList.add("history-row-bad");
    tr.innerHTML=`<td>${e.date}</td><td>${formatMoney(t.totalSales)}</td><td>${formatMoney(t.totalPurchases)}</td><td>${formatMoney(t.totalExpenses)}</td><td>${formatMoney(t.net)}</td><td>${formatMoney(t.netCash)}</td><td><button class="btn-small" onclick="loadDayToForm('${e.date}');window.scrollTo({top:0,behavior:'smooth'})">ØªØ¹Ø¯ÙŠÙ„</button></td>`;
    b.appendChild(tr);
  });
  document.getElementById("rangeSummary").textContent=entries.length?`Ø£ÙŠØ§Ù…: ${entries.length} | Ø±Ø¨Ø­ ${formatMoney(sn)} | ÙƒØ§Ø´ ${formatMoney(snc)}`:"Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª";
  updateAIInsights(0,0,0); // Trigger AI update
}

function updateAIInsights(){
  const box=document.getElementById("aiInsights");
  if(entries.length<2){box.textContent="ÙŠÙ„Ø²Ù… Ø¨ÙŠØ§Ù†Ø§Øª ÙŠÙˆÙ…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";return;}
  const s=entries.slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
  let tn=0;const ds=[];const ct={};
  s.forEach(e=>{
    const t=computeTotals(e.salesCash||0,e.salesCard||0,e.purchasesRows||[],e.expensesRows||[]);
    tn+=t.net;ds.push({date:e.date,net:t.net,sales:t.totalSales,margin:t.totalSales>0?(t.net/t.totalSales)*100:0});
    (e.purchasesRows||[]).forEach(r=>{const n=(r.name||"").trim()||"N/A";const v=toNum(r.cash)+toNum(r.card);if(v>0)ct[n]=(ct[n]||0)+v;});
  });
  const dc=ds.length, avg=tn/dc, ins=[];
  if(dc>=3){
    const l1=ds[dc-1].sales, l2=ds[dc-2].sales, l3=ds[dc-3].sales;
    ins.push(`ØªÙˆÙ‚Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØºØ¯: <span class="ai-tag tag-blue">${formatMoney(((l1*3)+(l2*2)+(l3))/6)} Ø±ÙŠØ§Ù„</span>`);
  }
  const arD=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"], dS={};
  ds.forEach(d=>{const i=new Date(d.date).getDay();if(!dS[i])dS[i]={s:0,c:0};dS[i].s+=d.net;dS[i].c++;});
  let bDn="",bDv=-Infinity;Object.keys(dS).forEach(i=>{const a=dS[i].s/dS[i].c;if(a>bDv){bDv=a;bDn=arD[i];}});
  if(bDn&&ds.length>5)ins.push(`Ø£ÙØ¶Ù„ ÙŠÙˆÙ… Ø±Ø¨Ø­ÙŠØ©: <strong>${bDn}</strong> (${formatMoney(bDv)})`);
  const ld=ds[dc-1];
  if(ld.sales>0){
    if(ld.margin<15)ins.push(`Ù‡Ø§Ù…Ø´ Ø±Ø¨Ø­ Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹ Ù„ÙŠÙˆÙ… ${ld.date} <span class="ai-tag tag-red">${ld.margin.toFixed(1)}%</span>`);
    else if(ld.margin>40)ins.push(`Ù‡Ø§Ù…Ø´ Ø±Ø¨Ø­ Ù…Ù…ØªØ§Ø² <span class="ai-tag tag-green">${ld.margin.toFixed(1)}%</span>`);
  }
  ins.push(`Ù…ØªÙˆØ³Ø· ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${formatMoney(avg)} Ø±ÙŠØ§Ù„`);
  box.innerHTML="<ul class='ai-list'>"+ins.map(i=>`<li>${i}</li>`).join("")+"</ul>";
}

window.openUploadModal=()=>{recalcLive();document.getElementById("uploadModal").style.display="flex";};
window.closeUploadModal=()=>{document.getElementById("uploadModal").style.display="none";};
window.setAttachType=(t)=>{currentAttachType=t;document.getElementById("fileInput").click();};
window.handleFiles=(inp)=>{
  if(!inp.files.length)return;
  Array.from(inp.files).forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{attachments[currentAttachType].push({name:f.name,type:f.type,data:e.target.result});renderAtt(currentAttachType);};
    r.readAsDataURL(f);
  });
  inp.value="";
};
function renderAtt(t){
  const b=document.getElementById("list_"+t);b.innerHTML="";
  attachments[t].forEach((f,i)=>{
    const d=document.createElement("div");d.className="file-tag";
    d.innerHTML=`<span class="file-name">${f.name}</span><span class="del-file" onclick="attachments['${t}'].splice(${i},1);renderAtt('${t}')">Ø­Ø°Ù</span>`;
    b.appendChild(d);
  });
}
window.generateAndShareReport=()=>{
  const t=recalcLive(), d=document.getElementById("dateInput").value, n=document.getElementById("noteInput").value;
  const br=(rs)=>(rs||[]).reduce((h,r)=>{const v=toNum(r.cash)+toNum(r.card);return v>0?h+`<tr><td>${r.name}</td><td>${formatMoney(v)}</td></tr>`:h;},'');
  const ph=br(purchasesRows), eh=br(expensesRows);
  const bag=(l,tt)=>l.length?`<div class="attach-section"><h3>${tt}</h3><div class="grid-img">${l.map(f=>f.type.includes('pdf')?`<div class="file-box"><div class="fname">${f.name}</div><a class="btn-download" href="${f.data}" download="${f.name}">PDF</a></div>`:`<div class="file-box"><img src="${f.data}"></div>`).join('')}</div></div>`:'';
  
  const h=`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Report ${d}</title>
  <style>body{font-family:sans-serif;background:#f5f5f5;padding:20px}.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1)}table{width:100%;border-collapse:collapse;margin-bottom:10px}th,td{border:1px solid #ddd;padding:8px;text-align:center}th{background:#eee}.pill{background:#f9f9f9;padding:10px;border:1px solid #eee;margin:5px;display:inline-block;min-width:120px;text-align:center}.grid-img{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:5px}.file-box img{width:100%;height:80px;object-fit:cover}</style></head>
  <body><div class="card"><h1>Tari Report <small>${d}</small></h1><p>${n}</p>
  <h3>Sales</h3><table><tr><td>Cash</td><td>${formatMoney(t.salesCash)}</td></tr><tr><td>Card</td><td>${formatMoney(t.salesCard)}</td></tr><tr><th>Total</th><th>${formatMoney(t.totalSales)}</th></tr></table>
  ${ph?`<h3>Purchases</h3><table>${ph}<tr><th>Total</th><th>${formatMoney(t.totalPurchases)}</th></tr></table>`:''}
  ${eh?`<h3>Expenses</h3><table>${eh}<tr><th>Total</th><th>${formatMoney(t.totalExpenses)}</th></tr></table>`:''}
  <div>
    <div class="pill"><strong>Net Profit</strong><br>${formatMoney(t.net)}</div>
    <div class="pill"><strong>Net Cash</strong><br>${formatMoney(t.netCash)}</div>
    <div class="pill"><strong>Month Sales</strong><br>${formatMoney(t.monthlySalesTotal)}</div>
  </div>
  ${bag(attachments.summaryReport,'Summary & Reports')}
  ${bag(attachments.purchCash,'Purchases (Cash)')}
  ${bag(attachments.purchCard,'Purchases (Card)')}
  ${bag(attachments.pos,'POS Receipts')}
  </div></body></html>`;

  const f=new File([new Blob([h],{type:"text/html"})], `Report_${d}.html`,{type:"text/html"});
  if(navigator.canShare&&navigator.canShare({files:[f]})) navigator.share({files:[f],title:`Report ${d}`});
  else {const u=URL.createObjectURL(f);const a=document.createElement("a");a.href=u;a.download=f.name;a.click();URL.revokeObjectURL(u);window.closeUploadModal();}
};

init();
</script>
</body>
</html>
